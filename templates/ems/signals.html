{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% load filters %}

{% block contents %}

<p class="pl-10 mt-5 text-2xl"> Signals </p>

<div class="pl-10 flex w-full my-2" x-init="fetchSignals();fetchEvents();">

    <!-- search signal input field-->
    <div class="flex rounded p-1 bg-gray-100 border border-gray-300 hover:bg-gray-200">
        <input  
            x-ref="searchSignal"
            x-model="search"
            x-on:keydown.window.prevent.slash="$refs.searchSignal.focus()"
            placeholder="Search signals"
            type="text"
            class="bg-transparent border-0 text-sm py-1 px-2 outline-none mr-2 border-transparent focus:border-transparent focus:ring-0" 
            />
        <div class="pt-1 px-2">
            <div x-show="search.length == 0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <div x-show="search.length > 0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hover:bg-gray-300" viewBox="0 0 20 20" fill="currentColor" @click="search=''">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>
    </div>

    <!-- filter buttons -->
    <div class="p-1">
        <button 
            class="ml-3  rounded bg-gray-100 hover:bg-gray-300 p-1 px-3 text-sm"
            :class="{ 'bg-gray-300': receivedToday }"
            @click="$refs.searchSignal.focus(), receivedToday = !receivedToday"> Received Today</button>
    </div>
    <div class="p-1">
        <button 
            class="rounded bg-gray-100 hover:bg-gray-300 p-1 px-3 text-sm"
            :class="{ 'bg-gray-300': receivedWeek }"
            @click="$refs.searchSignal.focus(), receivedWeek = !receivedWeek"> Received this week</button>
    </div>
    <div class="p-1">
        <button 
            class="rounded bg-gray-100 hover:bg-gray-300 p-1 px-3 text-sm" 
            :class="{ 'bg-gray-300': relevanceOver4 }" 
            @click="$refs.searchSignal.focus(), relevanceOver4 = !relevanceOver4"> Relevance over 4</button>
    </div>
</div>

<div class="flex h-full overflow-hidden">
    <div class="flex-1  h-full overflow-y-auto pl-10">
        <div class="flex justify-between">
            <p class="my-3 font-semibold text-sm"> Signals </p>
            <p class="my-3 p-1 px-3 rounded-sm text-sm text-white bg-emerald-700 hover:bg-emerald-900">Create Signal + </p>
        </div>
        <ul class="divide-y border text-sm">
            <template x-for="(signal, index) in filteredSignals" :key="index">
                <li 
                    class="p-2 flex hover:bg-gray-100 pr-10 space-x-3"  
                    :class="{'bg-emerald-100':activeSignal === index}"
                    :id="signal.id">

                    <p 
                        class="line-clamp-1 px-2 flex-1 hover:cursor-e-resize" 
                        @click="sidebarOpen = true, activeSignal = index, setSignal(signal)"
                        x-text="signal.contents_title"></p>

                    <span class="w-28" x-text="signal.channel"></span>
                    <span class="w-48" x-text="signal.created_on"></span>
                    <span class="rounded-lg bg-orange-300 px-3" x-text="signal.relevance"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-200 hover:text-slate-500 hover:cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" @click="discardSignal(signal)">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </li>
            </template>
        </ul>
        <p class="p-5"> Create Signal + </p>
    </div>
    <div class="flex-shrink-0 w-[570px] h-full flex flex-col overflow-y-hidden px-5 ml-5 transition-all duration-500" :class="{ '-mr-[570px]': !sidebarOpen }">
        <div class="py-2 flex justify-between">
            <div class="">
                Title
            </div>
            <div class="flex space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hover:bg-gray-100" viewBox="0 0 20 20" fill="currentColor" @click="sidebarOpen = false">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>
        <div class="h-full overflow-y-auto border-t border-transparent active:border-t">
            <p x-text="cur_signal.contents"></p>
            <div class="flex space-x-3 my-5">
                <button class="bg-gray-100 px-3 py-1 text-sm rounded-sm hover:bg-red-600 hover:text-white">
                    Discard
                </button>
                <button 
                    class="bg-gray-100 px-3 py-1 text-sm rounded-sm hover:bg-gray-300"
                    @click="eModal='attachEvent';showModal = true">
                    Attach to Alert
                </button>
                <button 
                    class="bg-gray-100 px-3 py-1 text-sm rounded-sm hover:bg-gray-300"
                    @click="openAddEvent()">
                    Set as Alert
                </button>
            </div>
            <p class="text-md mt-5 mb-3 text-bold">Details:</p>
            <ul class="flex flex-col space-y-4">
                <li class="flex space-x-16">
                    <p class="w-24 text-xs font-semibold">Channel</p>
                    <p class="text-sm" x-text="cur_signal.channel"></p>
                </li>
                <li class="flex space-x-16">
                    <p class="w-24 text-xs font-semibold">Contacts</p>
                    <p class="text-sm" x-text="cur_signal.contacts"></p>
                </li>
                <li class="flex space-x-16">
                    <p class="w-24 text-xs font-semibold">Relevance</p>
                    <p class="text-sm" x-text="cur_signal.relevance"></p>
                </li>
                <li class="flex space-x-16">
                    <p class="w-24 text-xs font-semibold">Status</p>
                    <p class="text-sm" x-text="cur_signal.status"></p>
                </li>
                <li class="flex space-x-16">
                    <p class="w-24 text-xs font-semibold">Received on</p>
                    <p class="text-sm" x-text="cur_signal.created_on"></p>
                </li>
            </ul>
        </div>
    </div>
</div>

  <!--Overlay-->
<div class="overflow-auto" style="background-color: rgba(0,0,0,0.5)" x-show="showModal" :class="{ 'absolute inset-0 z-10 flex items-center justify-center': showModal }">
    <!--Dialog-->
    <div class="bg-white w-9/12 lg:w-6/12  mx-auto rounded shadow-lg py-4 text-left px-6" x-show="showModal" @click.away="showModal = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100" >

        <!--Title-->
        <div class="flex justify-between items-center pb-3">
            <p class="text-2xl font-bold">Attach to Event</p>
            <div class="cursor-pointer z-50" @click="showModal = false">
                <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                    <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                </svg>
            </div>
        </div>

        <!-- content -->
        <template x-if="eModal=='attachEvent'">
            <div>
                <div class="flex rounded p-1 bg-gray-100 border border-gray-300 hover:bg-gray-200 my-4">
                    <input  
                        x-ref="searchEvent"
                        x-model="searchEvent"
                        x-on:keydown.window.prevent.slash="$refs.searchEvent.focus()"
                        placeholder="Search events"
                        type="text"
                        class="bg-transparent w-full border-0 text-sm py-1 px-2 outline-none mr-2 border-transparent focus:border-transparent focus:ring-0" 
                        />
                    <div class="pt-1 px-2">
                        <div x-show="searchEvent.length == 0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <div x-show="searchEvent.length > 0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hover:bg-gray-300" viewBox="0 0 20 20" fill="currentColor" @click="searchEvent=''">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>

                <ul class="divide-y border text-base">
                    <template x-for="(event, index) in filteredEvents" :key="index">
                        <li class="p-2 flex justify-between hover:bg-gray-100 space-x-3">
                            <div class="flex flex-col">
                                <p class="hover:cursor-pointer" x-text="event.title"></p>
                                <p class="text-xs font-light" x-text="event.location+' - '+event.status"></p>
                            </div>
                            <button class="bg-emerald-500 hover:bg-emerald-400 text-sm p-2 px-4 rounded-md" @click="attachSignal(event)">Attach</button>
                        </li>
                    </template>
                </ul>

                <!--Footer-->
                <div class="flex justify-end pt-2">
                    <button class="modal-close mr-3 text-white text-sm p-2 px-4 rounded-md bg-red-600 hover:bg-red-500 " @click="showModal = false">Close</button>
                </div>
            </div>
        </template>

        <template x-if="eModal=='setEvent'">
            <div class="flex flex-col text-xs" x-init="initjq()">

                <p class="mt-5 mb-1">Title</p>
                <input type="text" class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100"  x-model="new_event.title" required/>

                <p class="mt-5 mb-1">Description</p>
                <textarea id="textarea" name="description" class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100" maxlength="225" rows="3" placeholder="" x-model="new_event.description" required></textarea>
        
                <p class="mt-5 mb-1">Alert Type</p>
                <select class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100" id="alert_id" name="alert" aria-label="Alert"  x-model="new_event.alert" required>
                    {% for alert in alerts %}
                        <option value="{{alert.id}}">{{alert.reference}} : {{alert.title}}</option>
                    {% endfor %}
                </select>

                <p class="mt-5 mb-1">Location</p>
                <select x-ref="location" class="get_location text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100 md:w-1/2" id="location" name="location" x-model="new_event.location"></select>

                <p class="mt-5 mb-1">Primary Sector</p>
                <select x-ref="pri_sector" class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100"  name="pri_sector" id="pri_sector" data-placeholder="Choose ..."  x-model="new_event.pri_sector" required>
                    {% for sector in sectors %}
                        <option value="{{sector.id}}">{{sector.title}}</option>
                    {% endfor %}
                </select>

                <p class="mt-5 mb-1">Involved Sectors</p>
                <select x-ref="sectors" class="select2 select2-multiple text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100 multiple"  name="sector" id="sectors" multiple="multiple" data-placeholder="Choose ..."  x-model="new_event.sector" required>
                    {% for sector in sectors %}
                        <option value="{{sector.id}}">{{sector.title}}</option>
                    {% endfor %}
                </select>

                <p class="mt-5 mb-1">Contact Person</p>
                <input type="text" class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100"  x-model="new_event.contact_name" required/>

                <div class="mt-5 mb-1 flex justify-between">
                    <div>
                        <p class="mb-1">Profession</p>
                        <select class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100" id="profession" name="contact_prof" aria-label="Profession"  x-model="new_event.contact_prof">
                            <option selected="">Open this select menu</option>
                            {% for v, t in profession %}
                                <option value="{{v}}">{{t}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <p class="mb-1">Phone Number</p>
                        <input class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100 input-mask" data-inputmask="'mask': '+255-999-999-999'" im-insert="true" type="text"  x-model="new_event.contact_phone" />
                    </div>
                    <div>
                        <p class="mb-1">Email</p>
                        <input class="text-sm rounded-sm border-gray-300 bg-gray-50 hover:bg-gray-100" type="email" class=""  x-model="new_event.contact_email"/>
                    </div>
                </div>

                <p x-text="eventFormEl.message"></p>


                <!--Footer-->
                <div class="flex space-x-3 justify-end pt-2">
                    <button class="modal-close text-white text-sm p-2 px-4 rounded-md bg-red-600 hover:bg-red-500 " @click="showModal = false">Cancel</button>
                    <button 
                        class="modal-close text-white text-sm p-2 px-4 rounded-md bg-emerald-600 hover:bg-emerald-500 " 
                        @click="addEvent()"
                        x-text="eventFormEl.label" :disabled="eventFormEl.loading"></button>
                </div>

            </div>
        </template>
        



    </div>
    <!--/Dialog -->
</div><!-- /Overlay -->


{% endblock %}



{% block get_contents %}

<script src="{% static 'libs/popper/popper.min.js' %}"></script>
<link href="{% static 'libs/select2/css/select2.min.css' %}" rel="stylesheet" type="text/css">
<script src="{% static 'libs/jquery/jquery.min.js' %}"></script>
<script src="{% static 'libs/select2/js/select2.min.js' %}"></script>
<script src="{% static 'libs/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>

<script>


    function getContents() {
        return {
            search:         "",
            searchEvent:    "",
            sidebarOpen:    false,
            signals:        [],
            events:         [],
            relevanceOver4: false,
            receivedToday:  false,
            receivedWeek:   false,
            activeSignal:   -1,
            showModal:      false,
            eModal:         "setEvent",


            eventFormEl: {
                label:     "Add Event",
                loading:    false,
                message:    "" 
            },

            cur_signal: {
                id              : "",
                channel         : "", 
                contact         : "",
                contents        : "",
                relevance       : "",
                status          : "",
                created_on      : "",
            },

            new_event: {
                location        : "",
                alert           : "",
                contact_name    : "",
                title           : "",
                description     : "",
                pri_sector      : "",
                sector          : "",
                contact_prof    : "",
                contact_phone   : "",
                contact_email   : "",
                signal          : "",
            },

            

            setSignal(e){
                this.cur_signal = e;
                this.new_event.signal = e.id;
            },

            get filteredSignals() {

                // received Today
                if (this.receivedToday){
                    console.log('received today'+this.receivedToday)
                    this.signals = this.signals.filter((item) => {
                        return ( item.doy == {{t_doy}} );
                    })
                }else if (this.receivedWeek){
                    console.log('received today'+this.receivedWeek)
                    this.signals = this.signals.filter((item) => {
                        return ( item.doy < {{w_doy}} );
                    })
                }else if (this.relevanceOver4){
                    console.log('relevance over 4 '+this.relevanceOver4)
                    this.signals = this.signals.filter((item) => {
                        return (item.relevance == 0);
                    })
                }else{
                    this.fetchSignals(); 
                }


                if (this.search === "") {
                    return this.signals;
                }

                return this.signals.filter((item) => {
                    return item.contents
                        .toLowerCase()
                        .includes(this.search.toLowerCase());
                });
            },

            get filteredEvents() {

                if (this.searchEvent === "") {
                    return this.events;
                }

                return this.events.filter((item) => {
                    return item.description
                        .toLowerCase()
                        .includes(this.searchEvent.toLowerCase());
                });
            },


            fetchSignals(){
                this.signals = [
                    {% for signal in signals %}
                        {
                            id              : "{{ signal.id }}",
                            channel         : "{{ signal.channel }}", 
                            contact         : "{{ signal.contact }}",
                            contents        : "{{ signal.contents.text }} | {{ signal.contents.date }} | {{ signal.contents.ward }} | {{ signal.contents.village }} | {{ signal.contents.phone }} | {{ signal.contents.sector }}",
                            contents_title     : "{{ signal.contents.text }}",
                            contents_stitle    : "{{ signal.contents.date }} | {{ signal.contents.ward }} | {{ signal.contents.village }} | {{ signal.contents.phone }} | {{ signal.contents.sector }}",
                            relevance       : "{{ signal.relevance }}",
                            status          : "{{ signal.status }}",
                            created_on      : "{{ signal.created_on }}",
                            doy             : "{{ signal.doy }}",
                        },
                    {% endfor %}
                ]
            },

            fetchEvents(){
                this.events = [
                    {% for event in events %}
                        {
                            id              : "{{ event.id }}",
                            title           : "{{ event.title }}",
                            description     : "{{ event.description }}",
                            location        : "{{ event.location.title }}",
                            status          : "{{ event.status }}",
                            created_on      : "{{ event.created_on }}",
                        },
                    {% endfor %}
                ]
            },

            attachSignal(e){

                var url     = window.location.origin + '/ems/utils/as?sid='+this.cur_signal.id+'&eid='+e.id;
                console.log(url);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if(data == 1){
                            this.showModal = false;
                            this.signals.splice(this.signals.indexOf(this.cur_signal), 1);
                            this.signals = this.signals.filter(t => t.id !== this.cur_signal.id);
                        }
                    })
            },

            discardSignal(s){

                var url     = window.location.origin + '/ems/utils/di?ii='+s.id+'&it=si';
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if(data == 1){
                            this.showModal = false;
                            this.signals.splice(this.signals.indexOf(this.cur_signal), 1);
                            this.signals = this.signals.filter(t => t.id !== this.cur_signal.id);
                            document.getElementById(s.id).remove();

                            console.log('discard signal success')

                        }else{
                            console.log('failed to discard signal')
                        }
                    })
            },

            openAddEvent(){
                this.eModal='setEvent'
                this.showModal = true       
            },

            addEvent(){

                // set values
                const selected  = document.querySelectorAll('#sectors option:checked');
                const values    = Array.from(selected).map(el => el.value);

                this.new_event.location = this.$refs.location.value
                this.new_event.sector   = values


                var data = new FormData();
                data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                Object.entries(this.new_event).forEach(([key, value]) => {
                    data.append(key,value)
                });

                this.eventFormEl.label      = 'Submitting...'
                this.eventFormEl.loading    = true;
                this.eventFormEl.message    = ''

                var url     = window.location.origin + '/ems/utils/ae'


                fetch(url, {
                    method: 'POST',
                    body: data,
                    credentials : 'same-origin',
                })
                .then(res => res.json())
                .then(data => {
                    this.eventFormEl.message = 'Form sucessfully submitted!';
                    this.eventFormEl.loading = false;
                    this.eventFormEl.label = 'Add Event';

                    Object.keys(this.new_event).forEach(key => {
                        this.new_event[key] = "";
                    });

                    this.$refs.location.value = "";

                    const elements  = document.querySelectorAll('#sectors').options;
                    for(var i = 0; i < elements.length; i++){
                      elements[i].selected = false;
                    }

                    this.showModal =false;
                
                })
                .catch(() => {
                    this.eventFormEl.message = 'Ooops! Something went wrong!';
                    this.eventFormEl.loading = false;
                    this.eventFormEl.label = 'Add Event';
                })
                .finally(() => {
                    //this.eventFormEl.loading = false;
                    //this.eventFormEl.Label = 'Add Event'
                    this.eModal=''
                    this.showModal = false  
                })



            }

            
        }
    }

    function initjq() {

        $(".select2").select2();
        $(".input-mask").inputmask();

        $('.get_location').select2({
            minimumInputLength: 3,
            ajax: {
            url: window.location.origin + '/ems/utils/sl',
            dataType: 'json',
            // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
            }
        });

    };


</script>
{% endblock %}