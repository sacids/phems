{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% load filters %}

{% block contents %}

<main class="h-full bg-white" x-init="fetchWF();">
    <div class="bg-gray-100 h-16 py-4 px-4 sm:px-4 lg:px-4 flex justify-between">
        <div>
            <h1 class="text-xl font-medium tracking-tight text-gray-600">
                {{event.title}}
            </h1>
        </div>

        <div></div>
    </div>

    <div class="bg-white h-[calc(100%-4rem)] flex overflow-hidden relative">
        <div class="flex-1 h-full overflow-hidden">
            <div class="flex h-full">
                <div class="w-6/12 h-full overflow-y-scroll px-4 sm:px-4 lg:px-4">
                    <div class="w-full my-1 py-4 pr-4">
                        <div class="flex flex-col mb-4">
                            <p class="text-gray-500 text-sm font-normal">Title: </p>
                            <p class="font-normal text-gray-600 text-sm py-0">
                                {{event.title}}
                            </p>
                        </div>

                        <div class="flex flex-col mt-3 mb-4">
                            <p class="text-gray-500 text-sm font-normal">Description: </p>
                            <p class="font-normal text-gray-600 text-sm py-0">
                                {{event.description}}
                            </p>
                        </div>

                        <div class="flex justify-between mb-4">
                            <div class="flex flex-col">
                                <p class="text-gray-500 text-sm font-normal">Location: </p>
                                <p class="font-normal text-gray-600 text-sm py-0">
                                    {{event.location}}
                                </p>
                            </div>

                            <div>
                                <p class="text-gray-500 text-sm font-normal">Status: </p>
                                <p 
                                    class="text-white rounded-full px-2 py-1 text-xs font-medium"
                                    :class="cur_event.stage_class"
                                    x-text="cur_event.stage_title">
                                </p>

                            </div>
                        </div>

                        <div class="flex flex-col mb-4">
                            <p class="text-gray-500 text-sm font-normal">Alert Type: </p>
                            <p class="font-normal text-gray-600 text-sm py-0">
                                {{ event.alert.reference }} - {{ event.alert.title}}
                            </p>
                        </div>

                        <div class="flex justify-between mb-4">
                            <div class="flex flex-col">
                                <p class="text-gray-500 text-sm font-normal">Primary Sector: </p>
                                <p class="font-normal text-gray-600 text-sm py-0">
                                    {{ event.pri_sector.title}}
                                </p>
                            </div>

                            <div class="flex flex-col">
                                <p class="text-gray-500 text-sm font-normal">Tagged Sectors: </p>
                                <p class="font-normal text-gray-600 text-sm py-0">
                                    {% for val in event.sector.all %}
                                    {{val}},
                                    {% endfor %}
                                </p>
                            </div>
                        </div>

                        <div class="flex justify-between mb-4">
                            <div class="flex flex-col">
                                <p class="text-gray-500 text-sm font-normal">Created On: </p>
                                <p class="font-normal text-gray-600 text-sm py-0">
                                    {{ event.created_on}}
                                </p>
                            </div>

                            <div>
                                <p class="text-gray-500 text-sm font-normal">Created By: </p>
                                <p class="font-normal text-gray-600 text-sm py-0">
                                    {{ event.created_by.first_name}} {{ event.created_by.last_name}}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-6/12 h-full shadow-md">
                    <div class="border-b text-sm py-2 px-5 ">
                        <template  x-for="(wf, index) in workflow" :key="index">
                            <template x-if="wf.cur_stage==cur_event.stage_id">

                                <button 
                                    class="bg-gray-200 p-1 rounded-sm hover:bg-emerald-800 hover:text-white px-3" 
                                    :hx-get="'{% url 'change_wf' %}?ns='+wf.next_stage+'&ei={{event.id}}&fi='+wf.form_id" 
                                    hx-target="#parentDiv" 
                                    @click="cur_workflow = wf" 
                                    x-text="wf.label">
                                </button>

                            </template>
                        </template>
                    </div>
                    <div class="px-4 py-4">
                        <div class="flex space-x-2">
                            <button hx-get="{% url 'event-activities' event.id %}" hx-target="#parentDiv"
                                hx-swap="innerHTML"
                                class="bg-gray-300 px-2 py-1 rounded-sm text-sm hover:bg-green-800 hover:text-white">
                                Activities
                            </button>

                            {% if event.status == 'NEW' %}
                            <button hx-get="{% url 'initiate-event' event.id %}" hx-target="#parentDiv"
                                hx-swap="innerHTML"
                                class="bg-gray-300 px-2 py-1 rounded-sm text-sm hover:bg-green-800 hover:text-white">
                                Request For Confirmation
                            </button>
                            {% endif %}

                            {% if event.status == 'WAITING_CONFIRMATION' %}
                            <button hx-get="{% url 'event-sector-confirmation' event.id %}" hx-target="#parentDiv"
                                hx-swap="innerHTML"
                                class="bg-gray-300 px-2 py-1 rounded-sm text-sm hover:bg-green-800 hover:text-white">
                                Alert Confirmation
                            </button>
                            {% endif %}

                            {% if event.status == 'WAITING_CONFIRMATION' %}
                            <button hx-get="{% url 'event-confirmation' event.id %}" hx-target="#parentDiv"
                                hx-swap="innerHTML"
                                class="bg-gray-300 px-2 py-1 rounded-sm text-sm hover:bg-green-800 hover:text-white">
                                Confirm/Discard Alert
                            </button>
                            {% endif %}

                            {% if event.status == 'CONFIRMED' %}
                            <button hx-get="{% url 'event-progress-report' event.id %}" hx-target="#parentDiv"
                                hx-swap="innerHTML"
                                class="bg-gray-300 px-2 py-1 rounded-sm text-sm hover:bg-green-800 hover:text-white">
                                Progress Reports
                            </button>
                            {% endif %}

                            {% if event.status == 'CONFIRMED' %}
                            <button
                                class="bg-gray-300 px-2 py-1 rounded-sm text-sm hover:bg-green-800 hover:text-white">
                                Situation Reports
                            </button>
                            {% endif %}
                        </div>

                        <div id="parentDiv" class="py-2">
                            <div class="">
                                <div class="flex mb-0">
                                    <h4 class="text-sm font-medium py-1 uppercase text-gray-600">Alert Activities</h4>
                                </div>

                                {% if activities.count > 0%}
                                <ul role="list" class="divide-y divide-gray-200">
                                    {% for val in activities %}
                                    <li class="py-3 sm:py-4">
                                        <div class="flex justify-between">
                                            <div class="">
                                                <p class="text-sm font-medium text-gray-700 truncate">
                                                    {% if val.action == 'WAITING_CONFIRMATION' %}
                                                    <span>Waiting Confirmation</span>
                                                    {% elif val.action == 'CONFIRMED' %}
                                                    <span>Confirmation</span>
                                                    {% elif val.action == 'PROGRESS_REPORT' %}
                                                    <span>Progress Report</span>
                                                    {% elif val.action == 'SITUATION_REPORT' %}
                                                    <span>Situational Report</span>
                                                    {% endif %}
                                                </p>

                                                <p class="text-sm font-normal text-gray-600">
                                                    {% if val.action == 'WAITING_CONFIRMATION' %}
                                                    {% if val.confirmed == 1 %}
                                                    Confirmed: <span class="text-green-600 font-medium">Yes</span>
                                                    {% elif val.confirmed == 0 %}
                                                    Confirmed: <span class="text-red-600 font-medium">No</span>
                                                    {% endif %}
                                                    {% elif val.action == 'CONFIRMED' or val.action == 'DISCARDED' %}
                                                    {% if val.action == "CONFIRMED" %}
                                                    Confirmed: <span class="text-green-600 font-medium">Yes</span>
                                                    {% elif val.action == 'DISCARDED' %}
                                                    Confirmed: <span class="text-red-600 font-medium">No</span>
                                                    {% endif %}
                                                    {% endif %}
                                                </p>
                                            </div>

                                            <div class="">
                                                <p class="text-xs font-medium text-gray-600">
                                                    {{ val.created_by.first_name }} {{ val.created_by.last_name }}
                                                </p>

                                                <p class="text-xs  text-gray-500">
                                                    {{ val.created_on|date:"d-m-Y" }}
                                                </p>
                                            </div>
                                        </div>

                                        <div class="py-1">
                                            {% if val.action == 'WAITING_CONFIRMATION' %}
                                            {% if val.severity is not None %}
                                            <p class="text-sm text-gray-500 truncate py-1">
                                                Severity: {{ val.severity }}
                                            </p>
                                            {% endif %}
                                            {% endif %}

                                            <p class="text-sm text-gray-500 truncate py-1">
                                                {{ val.remarks }}
                                            </p>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="text-sm font-normal text-gray-600">No any activity</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extrastyle %}
<link href="{% static 'css/table.css' %}" rel="stylesheet" type="text/css" />
{% endblock extrastyle %}


{% block get_contents %}
<script src="{% static 'libs/popper/popper.min.js' %}"></script>
<link href="{% static 'libs/select2/css/select2.min.css' %}" rel="stylesheet" type="text/css">
<script src="{% static 'libs/jquery/jquery.min.js' %}"></script>
<script src="{% static 'libs/select2/js/select2.min.js' %}"></script>
<script src="{% static 'libs/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>

<!-- include summernote css/js -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>

<script>
    function getContents() { 

        return{


            workflow:           [],

            cur_event:{
                stage_id:       {{ event.stage.id }},
                stage_title:    "{{ event.stage.title }}",
                stage_class:    "{{ event.stage.css }}",
            },


            cur_workflow: {
                id              : "",
                wf_group        : "",
                cur_stage       : "",
                next_stage      : "",
                label           : "",
                form_id         : "",
            },


            fetchWF(){
                this.workflow = [
                    {% for workflow in workflows %}
                        {
                            id              : "{{ workflow.id }}",
                            wf_group        : "{{ workflow.wf_group }}",
                            cur_stage       : "{{ workflow.cur_stage.id }}",
                            next_stage      : "{{ workflow.next_stage.id }}",
                            label           : "{{ workflow.label}}",
                            form_id         : "{{ workflow.next_stage.form.id}}",
                        },
                    {% endfor %}
                ]
            },


            formData: {
            },

            UpdateWfForm() {

                console.log(JSON.stringify(this.formData)+' '+JSON.stringify(this.cur_workflow));

                // set values

                var data = new FormData();
                data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                data.append('ei',{{ event.id }})
                data.append('fi',JSON.stringify(this.formData))
                data.append('ns',this.cur_workflow.next_stage)

                var url     = window.location.origin + '/ems/utils/uwf'

                fetch(url, {
                    method: 'POST',
                    body: data,
                    credentials : 'same-origin',
                })
                .then(res => res.json())
                .then(data => {
                    console.log(data)
                    this.cur_event  = data
                    $('#parentDiv').html('update successfull')
                })
                .catch(() => {
                    console.log('something went wrong')
                })
                .finally(() => {
                    //this.eventFormEl.loading = false;
                    //this.eventFormEl.Label = 'Add Event'
                })


                //this.cur_stage.stage_id   = this.cur_workflow.next_stage;
                this.formData       = {};
            },

        }

    }

    function initjq() {
        $('#summernote').summernote();
        $(".select2").select2();
        $(".input-mask").inputmask();

        $('.get_location').select2({
            minimumInputLength: 3,
            ajax: {
                url: window.location.origin + '/ems/utils/sl',
                dataType: 'json',
                // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
            }
        });
    };
</script>
{% endblock %}